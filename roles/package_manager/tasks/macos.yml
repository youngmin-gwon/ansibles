---
- name: Ensure Homebrew is installed
  ansible.builtin.stat:
    path: /opt/homebrew/bin/brew
  register: homebrew_installed
  failed_when: false
  changed_when: false
  ignore_errors: true
  become: false
  when: ansible_system == "Darwin"
  tags: macos

- name: Install Homebrew if the package manager is not installed
  ansible.builtin.shell: >
    /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
  become: false
  when:
    - ansible_os_family == "Darwin"
    - not homebrew_installed.stat.exists
  changed_when: false
  tags: macos

- name: Ensure .zshrc includes Homebrew path for Apple Silicon-based machine
  ansible.builtin.lineinfile:
    path: "{{ lookup('env', 'HOME') }}/.zshrc"
    line: "export PATH=/opt/homebrew/bin:$PATH # brew"
    state: present
    create: yes
    insertbefore: "^{{ custom_config_end_delimiter }}"
    mode: 0644
  become: false
  when:
    - ansible_os_family == "Darwin"
    - ansible_facts['pkg_mgr'] == 'homebrew' # Ensures Homebrew is the package manager
  tags: macos
