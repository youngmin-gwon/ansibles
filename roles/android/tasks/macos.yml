---
- name: Ensure Android Command Line Tools in macOS
  community.general.homebrew_cask:
    name:
      - android-commandlinetools
      - android-studio-preview@canary
    state: present
  when: ansible_os_family == "Darwin"
  become: false
  tags: macos

- name: Find sdkmanager path
  ansible.builtin.command: which sdkmanager
  register: sdkmanager_path_result
  changed_when: false
  failed_when: false
  when: ansible_os_family == "Darwin"
  tags: macos

- name: Set Android SDK Root fact
  ansible.builtin.set_fact:
    android_sdk_root: "{{ sdkmanager_path_result.stdout | regex_replace('/cmdline-tools/latest/bin/sdkmanager$', '') }}"
  when:
    - ansible_os_family == "Darwin"
    - sdkmanager_path_result.stdout is defined and sdkmanager_path_result.stdout != ""
  tags: macos

- name: Fail if Android SDK Root could not be determined
  ansible.builtin.fail:
    msg: "Could not determine ANDROID_SDK_ROOT. Is Android Command Line Tools installed and in PATH?"
  when:
    - ansible_os_family == "Darwin"
    - android_sdk_root is not defined or android_sdk_root == ""
  tags: macos

- name: Define required Android SDK directories
  ansible.builtin.set_fact:
    android_sdk_directories:
      - name: "platform-tools"
        sdkmanager_arg: "platform-tools"
      - name: "platforms"
        sdkmanager_arg: "platforms;android-36"
      - name: "build-tools"
        sdkmanager_arg: "build-tools;36.0.0"
      - name: "system-images"
        sdkmanager_arg: "system-images;android-Baklava;google_apis_ps16k;arm64-v8a"
  tags: macos

# --- SDK ì»´í¬ë„ŒíŠ¸ ì„¤ì¹˜ ë©±ë“±ì„± ê°•í™” (ë™ì  ê²½ë¡œ ì‚¬ìš©) ---
- name: Check currently installed Android SDK components
  ansible.builtin.command: "{{ sdkmanager_path_result.stdout }} --list"
  register: sdk_list_output
  changed_when: false # ì´ ëª…ë ¹ì€ ìƒíƒœë¥¼ ë³€ê²½í•˜ì§€ ì•ŠìŒ
  failed_when: sdkmanager_path_result.stdout == "" or sdk_list_output.rc != 0
  when:
    - sdkmanager_path_result.stdout is defined and sdkmanager_path_result.stdout != "" # sdkmanager ê²½ë¡œê°€ ìˆì„ ë•Œë§Œ ì‹¤í–‰
  environment:
    ANDROID_SDK_ROOT: "{{ android_sdk_root }}"
  tags: macos

- name: Install missing Android SDK components
  ansible.builtin.command: '{{ sdkmanager_path_result.stdout }} --install "{{ item.sdkmanager_arg }}"'
  args:
    stdin: "y\n"
  when:
    - ansible_os_family == "Darwin"
    - sdkmanager_path_result.stdout is defined and sdkmanager_path_result.stdout != ""
    - sdk_list_output.stdout is defined
    - item.sdkmanager_arg not in sdk_list_output.stdout
  with_items: "{{ android_sdk_directories }}"
  changed_when: true
  register: sdkmanager_install
  environment:
    ANDROID_SDK_ROOT: "{{ android_sdk_root }}"
  failed_when: sdkmanager_install.rc != 0
  tags: macos

- name: Check if Android SDK licenses are already accepted
  ansible.builtin.command: "{{ sdkmanager_path_result.stdout }} --licenses"
  args:
    stdin: "n\n" # 'n'ì„ ì…ë ¥í•˜ì—¬ ë¼ì´ì„ ìŠ¤ ë™ì˜ë¥¼ í•˜ì§€ ì•Šê³  ìƒíƒœë§Œ í™•ì¸
  register: sdkmanager_licenses_check
  failed_when: false # ëª…ë ¹ì´ ì‹¤íŒ¨í•˜ë”ë¼ë„ ë‹¤ìŒ íƒœìŠ¤í¬ë¡œ ì§„í–‰
  changed_when: false
  environment:
    ANDROID_SDK_ROOT: "{{ android_sdk_root }}"
  tags: macos

- name: Agree on Android licenses
  ansible.builtin.shell: |
    "{{ sdkmanager_path_result.stdout }}" --licenses <<EOF
    y
    y
    y
    y
    y
    y
    EOF
  when: "'All SDK package licenses accepted.' not in sdkmanager_licenses_check.stdout"
  changed_when: true
  become: false
  environment:
    ANDROID_SDK_ROOT: "{{ android_sdk_root }}"
  tags: macos

# --- PATH ì¶”ê°€ (ë™ì  ê²½ë¡œ ì‚¬ìš©) ---
- name: Add Android Command Line Tools to PATH
  ansible.builtin.blockinfile:
    path: "{{ home_path }}/.zshrc"
    block: |
      export ANDROID_SDK_ROOT={{ android_sdk_root }}
      export PATH=$PATH:$ANDROID_SDK_ROOT/cmdline-tools/latest/bin
      export PATH=$PATH:$ANDROID_SDK_ROOT/platform-tools
    insertbefore: "^{{ custom_config_end_delimiter }}"
    state: present
    marker: "# --- {mark} Android SDK ---"
  when: ansible_os_family == "Darwin"
  become: false
  tags: macos

# --- Android Studio ì• í”Œë¦¬ì¼€ì´ì…˜ ê²½ë¡œ ë™ì  ì°¾ê¸° ---
- name: Find Android Studio application bundle path
  ansible.builtin.find:
    paths: "/Applications"
    file_type: directory
    patterns: "Android Studio Preview Canary.app" # ë˜ëŠ” ì„¤ì¹˜ëœ Android Studio ë²„ì „ì— ë§ëŠ” íŒ¨í„´
    recurse: no
  register: android_studio_app_bundle_result
  changed_when: false
  when: ansible_os_family == "Darwin"
  tags: macos

- name: Set Android Studio application bundle path fact
  ansible.builtin.set_fact:
    android_studio_app_bundle_path: "{{ android_studio_app_bundle_result.files[0].path }}"
  when:
    - android_studio_app_bundle_result.files is defined
    - android_studio_app_bundle_result.files | length > 0
    - ansible_os_family == "Darwin"
  tags: macos

- name: Get PIDs of running Android Studio instances using full path
  # ğŸš¨ ìˆ˜ì •: pgrep -f ì˜µì…˜ìœ¼ë¡œ ì „ì²´ ëª…ë ¹ì¤„ì„ ëŒ€ìƒìœ¼ë¡œ ê²€ìƒ‰í•˜ì—¬ PIDë¥¼ ì–»ìŒ
  ansible.builtin.command: "pgrep -f '{{ android_studio_app_bundle_path }}'"
  register: studio_process_pids
  changed_when: false
  failed_when: false # í”„ë¡œì„¸ìŠ¤ê°€ ì—†ìœ¼ë©´ 1ì´ ë°˜í™˜ë˜ë¯€ë¡œ ì‹¤íŒ¨ë¡œ ê°„ì£¼í•˜ì§€ ì•ŠìŒ
  when:
    - ansible_os_family == "Darwin"
    - android_studio_app_bundle_path is defined # ì•± ê²½ë¡œê°€ ì •ì˜ëœ ê²½ìš°ì—ë§Œ ì‹¤í–‰
  tags: macos

- name: Terminate Android Studio processes by PID
  # ğŸš¨ ìˆ˜ì •: kill ëª…ë ¹ì–´ë¥¼ ì‚¬ìš©í•˜ì—¬ ê° PIDë¥¼ ëª…ì‹œì ìœ¼ë¡œ ì¢…ë£Œ
  ansible.builtin.command: "kill -SIGTERM {{ item }}"
  loop: "{{ studio_process_pids.stdout_lines }}" # pgrepì˜ ì¶œë ¥ì€ PID ëª©ë¡ì´ë¯€ë¡œ ë¼ì¸ë³„ë¡œ ë°˜ë³µ
  when:
    - ansible_os_family == "Darwin"
    - studio_process_pids.rc == 0 # í”„ë¡œì„¸ìŠ¤ê°€ ì‹¤í–‰ ì¤‘ì¼ ë•Œ (ì¦‰, PIDê°€ ë°œê²¬ë  ë•Œ)ë§Œ ì¢…ë£Œ ëª…ë ¹ ì‹¤í–‰
  changed_when: true # ì¢…ë£Œ ëª…ë ¹ì´ ì‹¤í–‰ë˜ë©´ ë³€ê²½ëœ ê²ƒìœ¼ë¡œ ê°„ì£¼
  ignore_errors: true # ì´ë¯¸ ì¢…ë£Œë˜ì—ˆê±°ë‚˜ ì¢…ë£Œ ì¤‘ì¼ ìˆ˜ ìˆìœ¼ë¯€ë¡œ ì—ëŸ¬ ë¬´ì‹œ
  tags: macos
